# AquaSuite API

## Start
- Install: `npm install`
- Migrate: `npm run db:up`
- Run: `npm run dev` (local) or PM2 `pm2 restart aquasuite-api --update-env`

## Env vars
- `PORT` (default 3000)
- `DATABASE_URL`
- `UPLOADS_DIR` (defaults to `/opt/aquasuite/uploads/rosters`)

## Schema rules
- Migrations only (dbmate)
- No manual ALTER TABLE
- `db/schema.sql` is generated by dbmate

## Core tables
- `users`, `roles`, `sessions`
- `locations`, `user_location_access`
- `roster_uploads`
- `class_instances`
- `roster_entries`

## Key endpoints
- `POST /auth/login`
- `GET /locations`
- `POST /uploads/roster?locationId=...&date=YYYY-MM-DD`
- `GET /class-instances?locationId=...&date=...`
- `GET /roster-entries?locationId=...&date=...`
- `GET /roster-entries/mine?locationId=...&date=...`
- `POST /attendance`
- `POST /attendance/bulk`
- `GET /roster-uploads?locationId=...`

## /uploads/roster flow
1) Accept multipart HTML
2) Store file to disk, insert `roster_uploads`
3) Parse classes + swimmers
4) Insert `class_instances` + `roster_entries`
5) Return counts and summary

## Debugging
- `pm2 logs aquasuite-api --lines 200`
- `npm ls fastify @fastify/multipart`
- `psql "$DATABASE_URL" -c "\\d roster_entries"`
