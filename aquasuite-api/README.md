# AquaSuite API

## Start the API
- Install: `npm install`
- Migrations: `npm run db:up`
- Start: `npm run start` (server) or `npm run dev` (local)

## Required environment variables
- `PORT` (default 3000)
- `DATABASE_URL` (postgres connection string)
- `UPLOADS_DIR` (optional, defaults to `/opt/aquasuite/uploads/rosters`)

## Migrations (dbmate)
- Migrations live in `db/migrations`
- Run with `npm run db:up`
- `db/schema.sql` is generated by dbmate
- Never run manual ALTER TABLE in the shell

## Core tables
- `users`, `roles`, `sessions`
- `locations`, `user_location_access`
- `roster_uploads` (raw uploads metadata)
- `class_instances` (parsed schedule data)

## /uploads/roster end-to-end
1) User uploads HTML via multipart
2) API saves file to disk and inserts into `roster_uploads`
3) Parser extracts class data
4) API inserts `class_instances`
5) Returns `classesInserted` and parse summary

## Common errors
- 401 missing token: ensure Authorization header
- Multipart mismatch: check `@fastify/multipart` version vs Fastify v4
- Missing tables: run `npm run db:up`
- classesInserted=0: parser not matching HTML format

## Debug tips
- `pm2 logs aquasuite-api --lines 200`
- `npm ls fastify @fastify/multipart`
- `npx dotenv -e .env -- psql "$DATABASE_URL" -c "\\dt"`
